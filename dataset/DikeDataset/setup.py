import numpy as np
import pandas as pd
from tqdm import tqdm
import os
import sys
import inspect

SCRIPT_DIR = os.path.dirname(os.path.abspath(inspect.getfile(inspect.currentframe())))
PARENT_DIR = os.path.dirname(SCRIPT_DIR)
PARENT_DIR = os.path.dirname(PARENT_DIR)

sys.path.insert(0, PARENT_DIR) 

from lib.utils.pe import PE
from lib.utils.asm import ASM

benign = pd.read_csv(f'{SCRIPT_DIR}/benign.csv')
b_ids = benign['hash'].values

header_samples = np.empty((0, 53), dtype=np.int64)
asm_samples = np.empty((0, 69), dtype=np.int64)

for i in tqdm(range(0, len(b_ids)), desc="File analyzed"):
    id = b_ids[i]
    file = f"{SCRIPT_DIR}/benign/{id}.exe"
    if os.path.exists(file):

        try:
            header = PE(file)
            features = header.header_features.reshape(1, -1)
            features = np.append(features, [[0]], axis=1)  
            header_samples = np.append(header_samples, features, axis=0)


            asm = ASM(file)
            features = asm.assembly_features.reshape(1, -1)
            features = np.append([[id]], features, axis=1) 
            features = np.append(features, [[9]], axis=1)
            asm_samples = np.append(asm_samples, features, axis=0)

        except Exception as _:
            # Error if .exe file is a DOZ MZ executable
            # DOS MZ executable format is the executable file format used for .EXE files in DOS.
            pass

np.savetxt(f"{SCRIPT_DIR}/b_header.csv", header_samples, fmt='%d', delimiter=",")
np.savetxt(f"{SCRIPT_DIR}/b_asm.csv", asm_samples, fmt='%s', delimiter=",")
